{% extends 'base.html' %}
{% load static %}

{% block title %}Home | MyShop{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-md-3 mb-4">
      <h5 class="fw-bold">Categories</h5>
      <ul class="list-group" id="category-list"></ul>
    </div>

    <div class="col-md-9">
      <div class="row" id="product-list"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const token = localStorage.getItem("token");

  if (!token) {
    window.location.href = "/api/store/login-ui/";
    return;
  }

  fetchCategories();
  fetchProducts();

  async function fetchCategories() {
    const res = await fetch('/api/store/admin/category/list/', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!res.ok) return;
    const data = await res.json();

    const list = document.getElementById('category-list');
    list.innerHTML = '';

    data.data.categories.forEach(category => {
      const li = document.createElement('li');
      li.className = 'list-group-item list-group-item-action';
      li.textContent = category.name;
      li.style.cursor = 'pointer';
      li.onclick = () => fetchProducts(category.slug);
      list.appendChild(li);
    });
  }

  async function fetchProducts(categorySlug = '') {
    const res = await fetch('/api/store/', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!res.ok) return;
    const data = await res.json();
    const list = document.getElementById('product-list');
    list.innerHTML = '';

    let products = data.data.products;
    if (categorySlug) {
      products = products.filter(p => p.category_slug === categorySlug);
    }

    if (products.length === 0) {
      list.innerHTML = `<div class="col-12"><p class="text-muted">No products found.</p></div>`;
    }

    products.forEach(product => {
      const card = document.createElement('div');
      card.className = 'col-md-4 mb-4';
      card.innerHTML = `
        <div class="card h-100 shadow-sm">
          <img src="${product.image || 'https://via.placeholder.com/300'}" class="card-img-top" alt="${product.name}">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">${product.name}</h5>
            <p class="card-text text-muted">â‚¹${product.price}</p>
            <button class="btn btn-outline-primary mt-auto w-100">
              <i class="fas fa-cart-plus"></i> Add to Cart
            </button>
          </div>
        </div>
      `;
      list.appendChild(card);
    });
  }
});
</script>
{% endblock %}
